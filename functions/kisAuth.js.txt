const axios = require("axios");
const functions = require("firebase-functions");

const BASE_URL = "https://openapi.koreainvestment.com:9443";

let cachedToken = null;
let cachedExpireMs = 0;

async function getAccessToken() {
  const now = Date.now();
  if (cachedToken && now < cachedExpireMs - 60_000) {
    return cachedToken;
  }

  const appkey = functions.config().kis.appkey;
  const appsecret = functions.config().kis.appsecret;

  if (!appkey || !appsecret) {
    throw new Error("Missing kis.appkey or kis.appsecret in functions config");
  }

  const url = `${BASE_URL}/oauth2/tokenP`;

  const body = {
    grant_type: "client_credentials",
    appkey,
    appsecret,
  };

  const res = await axios.post(url, body, {
    headers: { "Content-Type": "application/json" },
    timeout: 15000,
  });

  cachedToken = res.data.access_token;
  const expiresInSec = Number(res.data.expires_in || 86400);
  cachedExpireMs = now + expiresInSec * 1000;

  return cachedToken;
}

module.exports = { getAccessToken, BASE_URL };
